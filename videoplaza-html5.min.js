/*! videoplaza-html5 - v0.1.0 - 2012-10-30
* https://github.com/aptoma/videoplaza-html5
* Copyright (c) 2012 ; Licensed MIT */
function VideoplazaAds(e,t){this.vpHost=e,this.requestSettings={width:null,height:null,bitrate:null,insertionPointType:null,playbackPosition:null},this.adPlaying=!1,this.adsEnabled=!0,this.midrolls=[],this.lastPlayedMidroll=null,this.debug=!!t,this.skipHandler={start:null,end:null},this.adCall=new videoplaza.core.AdCallModule(e),this.tracker=new videoplaza.core.Tracker}var VPT=videoplaza.core.Tracker.trackingEvents;VideoplazaAds.prototype.log=function(){this.debug&&console.log&&console.log(arguments)},VideoplazaAds.prototype.setSkipHandler=function(e,t){this.skipHandler.start=e,this.skipHandler.end=t},VideoplazaAds.prototype.skipCurrentAd=function(){this._showNextAd()},VideoplazaAds.prototype.setAdsEnabled=function(e){this.adsEnabled=e},VideoplazaAds.prototype.setCompanionHandler=function(e){this.companionHandler=e},VideoplazaAds.prototype.setMidrolls=function(e){typeof e==typeof []&&(e=e.sort(function(e,t){return e-t})),this.midrolls=e,this.lastPlayedMidroll=null},VideoplazaAds.prototype._listen=function(e,t,n){var r=this,i=function(e){n.call(r,e)};typeof e.addEventListener=="function"?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)},VideoplazaAds.prototype.setContentMeta=function(e){this.contentMeta=e},VideoplazaAds.prototype.setVideoProperties=function(e,t,n){this.requestSettings.width=e,this.requestSettings.height=t,this.requestSettings.bitrate=n},VideoplazaAds.prototype._onAds=function(e){this.log("got ads",e),this.ads=e,this.adIndex=-1,this._showNextAd()},VideoplazaAds.prototype._showNextAd=function(){this.adIndex++;if(!this.adsEnabled||this.adIndex>=this.ads.length)return this.log("no more ads"),typeof this.skipHandler.end=="function"&&this.skipHandler.end.call(this),this._resumeWatchedPlayer(),!1;this.log("showing ad #"+this.adIndex),this.ad=this.ads[this.adIndex];switch(this.ad.type){case"standard_spot":return this.log("found standard spot"),this._displayAdCreatives(this.ad.creatives),!0;case"inventory":return this.log("found inventory"),this.tracker.track(this.ad,VPT.ad.impression),this._showNextAd();default:return this._onError("ad format "+this.ad.type+" not supported"),!1}},VideoplazaAds.prototype._showCompanion=function(e){this.log("show companion banner",e);if(typeof this.companionHandler!="function")return!1;var t='<iframe scrolling="no" frameborder="0" width="'+e.width+'" '+'height="'+e.height+'" '+'src="'+e.resource+'"></iframe>';return this.companionHandler(t,e.zoneId,e.width,e.height)?(this.tracker.track(e,VPT.creative.creativeView),!0):!1},VideoplazaAds.prototype._displayAdCreatives=function(e){this.adVideo=null,this.log("found "+e.length+" creatives for ad");for(var t=0,n=e.length;t<n;t++)e[t].id==="video"?(this.log("found video creative",e[t]),this.adVideo=e[t]):e[t].type==="companion"&&(this.log("found companion creative",e[t]),this._showCompanion(e[t])||console.error("Videoplaza error: no way of displaying companion ad"));if(!this.adVideo){console.error("Videoplaza error: bad ad - no video",this.ad),this._showNextAd();return}this._playVideoAd()},VideoplazaAds.prototype._onError=function(e){console.error&&console.error("Videoplaza error: "+e),this._resumeWatchedPlayer()},VideoplazaAds.prototype._runAds=function(e,t){this.watchedPlayer.pause(),this.requestSettings.insertionPointType=e,t?this.requestSettings.playbackPosition=this.watchedPlayer.currentTime:this.requestSettings.playbackPosition=null;var n=this,r=function(e){n._onAds.call(n,e)},i=function(e){n._onError.call(n,e)};this.adCall.requestAds(this.contentMeta,this.requestSettings,r,i)},VideoplazaAds.prototype._destroyAdPlayer=function(){this.log("told to destroy ad player"),this.adPlayer&&(this.log("actually destroyed ad player"),this.adPlayer.parentNode.removeChild(this.adPlayer),this.watchedPlayer.style.display="block",this.adPlayer=null)},VideoplazaAds.prototype._onAdPlay=function(){this.adPlaying?(this.log("ad resumed"),this.tracker.track(this.adVideo,VPT.creative.resume)):(this.log("ad started playing"),this.tracker.track(this.ad,VPT.ad.impression),this.tracker.track(this.adVideo,VPT.creative.creativeView),this.tracker.track(this.adVideo,VPT.creative.start)),this.adPlaying=!0},VideoplazaAds.prototype._onAdClick=function(e){this.log("ad click through to "+this.adVideo.clickThroughUri),this.tracker.track(this.adVideo,VPT.creative.clickThrough),window.open(this.adVideo.clickThroughUri,"_blank"),e.preventDefault()},VideoplazaAds.prototype._onAdTick=function(e){var t=this.adPlayer.currentTime/this.adVideo.duration;if(this.unsentQuartiles.length&&t>this.unsentQuartiles[0]){var n=this.unsentQuartiles.shift();switch(n){case.25:this.log("logged first quartile"),this.tracker.track(this.adVideo,VPT.creative.firstQuartile);break;case.5:this.log("logged midpoint"),this.tracker.track(this.adVideo,VPT.creative.midpoint);break;case.75:this.log("logged third quartile"),this.tracker.track(this.adVideo,VPT.creative.thirdQuartile)}}},VideoplazaAds.prototype._createAdPlayer=function(){return this.log("told to create ad player"),this.watchedPlayer&&!this.adPlayer?(this.log("actually created ad player"),this.adPlayer=document.createElement("video"),this.adPlayer.setAttribute("width",this.watchedPlayer.clientWidth||this.watchedPlayer.offsetWidth),this.adPlayer.setAttribute("height",this.watchedPlayer.clientHeight||this.watchedPlayer.offsetHeight),this.adPlayer.setAttribute("controls",!1),this.adPlayer.setAttribute("preload",!0),this._listen(this.adPlayer,"play",this._onAdPlay),this._listen(this.adPlayer,"click",this._onAdClick),this._listen(this.adPlayer,"canplay",this._onAdCanPlay),this._listen(this.adPlayer,"timeupdate",this._onAdTick),this._listen(this.adPlayer,"ended",this._showNextAd),this.adPlayer.style.display="none",this.watchedPlayer.parentNode.insertBefore(this.adPlayer,this.watchedPlayer),this.watchedPlayer.style.display="none",this.adPlayer.style.display="block",this.adPlaying=!1,!0):!1},VideoplazaAds.prototype._playVideoAd=function(){this.log("playing ad",this.adVideo),this.unsentQuartiles=[.25,.5,.75],this._createAdPlayer(),typeof this.skipHandler.start=="function"&&this.skipHandler.start.call(this,this.adVideo.duration),this.adPlayer.setAttribute("src",this.adVideo.mediaFiles[0].uri),this.adPlayer.load()},VideoplazaAds.prototype._onAdCanPlay=function(){this.adPlayer.play()},VideoplazaAds.prototype._resumeWatchedPlayer=function(){this.log("resuming watched player"),this._destroyAdPlayer(),this.watchedPlayer&&this.watchedPlayer.paused&&!this.watchedPlayer.ended&&this.watchedPlayer.play(),this.watchedPlayer.ended&&this._triggerVideoEvent("ended")},VideoplazaAds.prototype._triggerVideoEvent=function(e){if(!this.watchedPlayer)return;var t;document.createEvent?(t=document.createEvent("HTMLEvents"),t.initEvent(e,!0,!0)):(t=document.createEventObject(),t.eventType=e),document.createEvent?this.watchedPlayer.dispatchEvent(t):this.watchedPlayer.fireEvent("on"+t.eventType,t)},VideoplazaAds.prototype._checkForMidroll=function(){var e=this.watchedPlayer.startTime+this.watchedPlayer.currentTime,t=null;for(var n=0,r=this.midrolls.length;n<r;n++){if(this.midrolls[n]>e)break;t=n}t!==null&&t!==this.lastPlayedMidroll&&(this.log("playing overdue midroll "+t),this.lastPlayedMidroll=t,this._runAds("playbackPosition",!0))},VideoplazaAds.prototype.watchPlayer=function(e){return this.log("told to watch player",e),this._destroyAdPlayer(),e.tagName.toLowerCase()!=="video"?(console.error("not watching player - not a video element"),!1):(this.watchedPlayer=e,this.shownPreroll=!1,this.watchedPlayer.paused||(this._runAds("onBeforeContent"),this.shownPreroll=!0),this._listen(e,"play",function(e){this.shownPreroll||(this._runAds("onBeforeContent"),this.shownPreroll=!0,e.ignore=!0)}),this._listen(e,"timeupdate",this._checkForMidroll),this.shownPostroll=!1,this._listen(e,"ended",function(e){this.shownPostroll||(this._runAds("onContentEnd"),this.shownPostroll=!0,e.ignore=!0)}),!0)};