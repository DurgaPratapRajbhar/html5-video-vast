/*! videoplaza-html5 - v0.1.1 - 2012-11-05
* https://github.com/aptoma/videoplaza-html5
* Copyright (c) 2012 ; Licensed MIT */
function VideoplazaAds(e,t){this.vpHost=e,this.requestSettings={width:null,height:null,bitrate:null,insertionPointType:null,playbackPosition:null},this.adPlaying=!1,this.adsEnabled=!0,this.midrolls=[],this.lastPlayedMidroll=null,this.debug=!!t,this.skipHandler={start:null,end:null},this.adCall=new videoplaza.core.AdCallModule(e),this.tracker=new videoplaza.core.Tracker,this.trackingEvents=videoplaza.core.Tracker.trackingEvents}VideoplazaAds.prototype.log=function(){this.debug&&console.log&&console.log.apply(console,arguments)},VideoplazaAds.prototype.logError=function(){console.error&&console.error.apply(console,arguments)},VideoplazaAds.prototype.setSkipHandler=function(t,n){this.skipHandler.start=t,this.skipHandler.end=n},VideoplazaAds.prototype.skipCurrentAd=function(){this._showNextAd()},VideoplazaAds.prototype.setAdsEnabled=function(t){this.adsEnabled=t},VideoplazaAds.prototype.setCompanionHandler=function(t){this.companionHandler=t},VideoplazaAds.prototype.setMidrolls=function(t){typeof t==typeof []&&t.sort(function(e,t){return e-t}),this.midrolls=t,this.lastPlayedMidroll=null},VideoplazaAds.prototype._listen=function(t,n,r){var i=this,s=function(e){r.call(i,e)};typeof t.addEventListener=="function"?t.addEventListener(n,s,!1):t.attachEvent("on"+n,s)},VideoplazaAds.prototype.setContentMeta=function(t){this.contentMeta=t},VideoplazaAds.prototype.setVideoProperties=function(t,n,r){this.requestSettings.width=t,this.requestSettings.height=n,this.requestSettings.bitrate=r},VideoplazaAds.prototype._onAds=function(t){this.log("got ads",t),this.ads=t,this.adIndex=-1,this._showNextAd()},VideoplazaAds.prototype._showNextAd=function(){this.adIndex++;if(!this.adsEnabled||this.adIndex>=this.ads.length)return this.log("no more ads"),typeof this.skipHandler.end=="function"&&this.skipHandler.end.call(this),this._resumeWatchedPlayer(),!1;this.log("showing ad #"+this.adIndex),this.ad=this.ads[this.adIndex];switch(this.ad.type){case"standard_spot":return this.log("found standard spot"),this._displayAdCreatives(this.ad.creatives),!0;case"inventory":return this.log("found inventory"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this._showNextAd();default:return this._onError("ad format "+this.ad.type+" not supported"),!1}},VideoplazaAds.prototype._showCompanion=function(t){this.log("show companion banner",t);if(typeof this.companionHandler!="function")return!1;var n='<iframe scrolling="no" frameborder="0" width="'+t.width+'" '+'height="'+t.height+'" '+'src="'+t.resource+'"></iframe>';return this.companionHandler(n,t.zoneId,t.width,t.height)?(this.tracker.track(t,this.trackingEvents.creative.creativeView),!0):!1},VideoplazaAds.prototype._displayAdCreatives=function(t){this.adVideo=null,this.log("found "+t.length+" creatives for ad");for(var n=0,r=t.length;n<r;n++)t[n].id==="video"?(this.log("found video creative",t[n]),this.adVideo=t[n]):t[n].type==="companion"&&(this.log("found companion creative",t[n]),this._showCompanion(t[n])||this.logError("Videoplaza error: no way of displaying companion ad"));if(!this.adVideo){this.logError("Videoplaza error: bad ad - no video",this.ad),this._showNextAd();return}this._playVideoAd()},VideoplazaAds.prototype._onError=function(t){this.logError("Videoplaza error: "+t),this._resumeWatchedPlayer()},VideoplazaAds.prototype._runAds=function(t,n){this.watchedPlayer.pause(),this.requestSettings.insertionPointType=t,n?this.requestSettings.playbackPosition=this.watchedPlayer.currentTime:this.requestSettings.playbackPosition=null;var r=this,i=function(t){r._onAds.call(r,t)},s=function(t){r._onError.call(r,t)};this.adCall.requestAds(this.contentMeta,this.requestSettings,i,s)},VideoplazaAds.prototype._destroyAdPlayer=function(){this.log("told to destroy ad player"),this.adPlayer&&(this.log("actually destroyed ad player"),this.adPlayer.parentNode.removeChild(this.adPlayer),this.watchedPlayer.style.display="block",this.adPlayer=null)},VideoplazaAds.prototype._onAdPlay=function(){this.adPlaying?(this.log("ad resumed"),this.tracker.track(this.adVideo,this.trackingEvents.creative.resume)):(this.log("ad started playing"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this.tracker.track(this.adVideo,this.trackingEvents.creative.creativeView),this.tracker.track(this.adVideo,this.trackingEvents.creative.start)),this.adPlaying=!0},VideoplazaAds.prototype._onAdClick=function(t){return this.adPlaying?(this.log("ad click through to "+this.adVideo.clickThroughUri),this.tracker.track(this.adVideo,this.trackingEvents.creative.clickThrough),window.open(this.adVideo.clickThroughUri,"_blank"),t.preventDefault(),!1):(this.log("ad click with no ad playing, fallthrough to start playback."),!0)},VideoplazaAds.prototype._onAdTick=function(t){if(!this.adPlayer||!this.adVideo)return this.log("Ad player or ad video not ready"),!1;var n=this.adPlayer.currentTime/this.adVideo.duration;if(this.unsentQuartiles.length&&n>this.unsentQuartiles[0]){var r=this.unsentQuartiles.shift();switch(r){case.25:this.log("logged first quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.firstQuartile);break;case.5:this.log("logged midpoint"),this.tracker.track(this.adVideo,this.trackingEvents.creative.midpoint);break;case.75:this.log("logged third quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.thirdQuartile)}}return!0},VideoplazaAds.prototype._createAdPlayer=function(){return this.log("told to create ad player"),this.watchedPlayer&&!this.adPlayer?(this.log("actually created ad player"),this.adPlayer=document.createElement("video"),this.adPlayer.setAttribute("width",this.watchedPlayer.clientWidth||this.watchedPlayer.offsetWidth),this.adPlayer.setAttribute("height",this.watchedPlayer.clientHeight||this.watchedPlayer.offsetHeight),navigator.userAgent.match(/iPad|iPod|iPhone|Android/)&&this.adPlayer.setAttribute("controls"),this.adPlayer.setAttribute("preload","auto"),this._listen(this.adPlayer,"play",this._onAdPlay),this._listen(this.adPlayer,"click",this._onAdClick),this._listen(this.adPlayer,"canplay",this._onAdCanPlay),this._listen(this.adPlayer,"timeupdate",this._onAdTick),this._listen(this.adPlayer,"ended",this._showNextAd),this.adPlayer.style.display="none",this.watchedPlayer.parentNode.insertBefore(this.adPlayer,this.watchedPlayer),this.watchedPlayer.style.display="none",this.adPlayer.style.display="block",this.adPlaying=!1,!0):!1},VideoplazaAds.prototype._playVideoAd=function(){this.log("playing ad",this.adVideo),this.unsentQuartiles=[.25,.5,.75],this._createAdPlayer(),typeof this.skipHandler.start=="function"&&this.skipHandler.start.call(this,this.adVideo.duration),this.adPlayer.setAttribute("src",this.adVideo.mediaFiles[0].uri),this.adPlayer.load()},VideoplazaAds.prototype._onAdCanPlay=function(){this.adPlayer.play()},VideoplazaAds.prototype._resumeWatchedPlayer=function(){this.log("resuming watched player"),this._destroyAdPlayer(),this.watchedPlayer&&this.watchedPlayer.paused&&!this.watchedPlayer.ended&&this.watchedPlayer.play(),this.watchedPlayer.ended&&this._triggerVideoEvent("ended")},VideoplazaAds.prototype._triggerVideoEvent=function(t){if(!this.watchedPlayer)return;var n;document.createEvent?(n=document.createEvent("HTMLEvents"),n.initEvent(t,!0,!0)):(n=document.createEventObject(),n.eventType=t),document.createEvent?this.watchedPlayer.dispatchEvent(n):this.watchedPlayer.fireEvent("on"+n.eventType,n)},VideoplazaAds.prototype._checkForPreroll=function(t){this.hasShownPreroll||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0,t.ignore=!0)},VideoplazaAds.prototype._checkForMidroll=function(){if(this.midrolls.length===0)return!1;var t=null;for(var n=0,r=this.midrolls.length;n<r;n++){if(this.midrolls[n]>this.watchedPlayer.currentTime)break;t=n}return t!==null&&t!==this.lastPlayedMidroll?(this.log("playing overdue midroll "+t),this.lastPlayedMidroll=t,this._runAds("playbackPosition",!0),!0):!1},VideoplazaAds.prototype._checkForPostroll=function(t){this.hasShownPostroll||(this._runAds("onContentEnd"),this.hasShownPostroll=!0,t.ignore=!0)},VideoplazaAds.prototype._needControls=function(){return navigator.userAgent.match(/iPad|iPod|iPhone|Android/)},VideoplazaAds.prototype.watchPlayer=function(t){return this.log("told to watch player",t),this._destroyAdPlayer(),t.tagName.toLowerCase()!=="video"?(this.logError("not watching player - not a video element"),!1):(this.watchedPlayer=t,this.hasShownPreroll=!1,this.hasShownPostroll=!1,this.watchedPlayer.paused||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0),this._listen(t,"play",this._checkForPreroll),this._listen(t,"timeupdate",this._checkForMidroll),this._listen(t,"ended",this._checkForPostroll),!0)};