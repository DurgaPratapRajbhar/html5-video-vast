/*! videoplaza-html5 - v0.1.4 - 2012-12-14
* https://github.com/aptoma/videoplaza-html5
* Copyright (c) 2012 ; Licensed MIT */
function VideoplazaAds(e,t){this.vpHost=e,this.requestSettings={width:null,height:null,bitrate:null,insertionPointType:null,playbackPosition:null},this.adPlaying=!1,this.adsEnabled=!0,this.midrolls=[],this.lastPlayedMidroll=null,this.debug=!!t,this.skipHandler={start:null,end:null},this._playerState={originalSrc:null,timeToResume:0,ended:!1},this.takeoverCallbacks={onTakeover:null,onRelease:null},this._clickEvent=navigator.userAgent.match(/iPad/i)?"touchstart":"click",this._bindContextForCallbacks(),this.adCall=new videoplaza.core.AdCallModule(e),this.tracker=new videoplaza.core.Tracker,this.trackingEvents=videoplaza.core.Tracker.trackingEvents}VideoplazaAds.prototype.log=function(){this.debug&&console.log&&console.log.apply&&console.log.apply(console,arguments)},VideoplazaAds.prototype.logError=function(){console.error&&console.error.apply?console.error.apply(console,arguments):this.log.apply(arguments)},VideoplazaAds.prototype.setSkipHandler=function(t,n){this.skipHandler.start=t,this.skipHandler.end=n},VideoplazaAds.prototype.setTakeoverCallbacks=function(t,n){this.takeoverCallbacks.onTakeover=t,this.takeoverCallbacks.onRelease=n},VideoplazaAds.prototype.skipCurrentAd=function(){this._showNextAd()},VideoplazaAds.prototype.setAdsEnabled=function(t){this.adsEnabled=t},VideoplazaAds.prototype.setCompanionHandler=function(t){this.companionHandler=t},VideoplazaAds.prototype.setMidrolls=function(t){typeof t==typeof []&&t.sort(function(e,t){return e-t}),this.midrolls=t,this.lastPlayedMidroll=null},VideoplazaAds.prototype.setContentMeta=function(t){this.contentMeta=t},VideoplazaAds.prototype.setVideoProperties=function(t,n,r){this.requestSettings.width=t,this.requestSettings.height=n,this.requestSettings.bitrate=r},VideoplazaAds.prototype._needControls=function(){return navigator.userAgent.match(/iPad|iPod|iPhone|Android/)},VideoplazaAds.prototype._bindContextForCallbacks=function(){this._onAdPlay=this._onAdPlay.bind(this),this._onAdCanPlay=this._onAdCanPlay.bind(this),this._onAdClick=this._onAdClick.bind(this),this._onAdClickToResume=this._onAdClickToResume.bind(this),this._onAdTick=this._onAdTick.bind(this),this._showNextAd=this._showNextAd.bind(this),this._checkForPreroll=this._checkForPreroll.bind(this),this._checkForMidroll=this._checkForMidroll.bind(this),this._checkForPostroll=this._checkForPostroll.bind(this),this._onVideoCanPlay=this._onVideoCanPlay.bind(this)},VideoplazaAds.prototype._listen=function(t,n,r){t.addEventListener(n,r,!1)},VideoplazaAds.prototype._unlisten=function(t,n,r){t.removeEventListener(n,r,!1)},VideoplazaAds.prototype._takeover=function(){this.log("take over player"),this.player.controls=!1,this._listen(this.player,"play",this._onAdPlay),this._listen(this.player,this._clickEvent,this._onAdClick),this._listen(this.player,"canplay",this._onAdCanPlay),this._listen(this.player,"timeupdate",this._onAdTick),this._listen(this.player,"ended",this._showNextAd),this._unlisten(this.player,"canplay",this._onVideoCanPlay),this._unlisten(this.player,"play",this._checkForPreroll),this._unlisten(this.player,"timeupdate",this._checkForMidroll),this._unlisten(this.player,"ended",this._checkForPostroll),typeof this.takeoverCallbacks.onTakeover=="function"&&this.takeoverCallbacks.onTakeover(this.player)},VideoplazaAds.prototype._release=function(){this.log("release player"),this.player.controls=!0,this._unlisten(this.player,"play",this._onAdPlay),this._unlisten(this.player,this._clickEvent,this._onAdClick),this._unlisten(this.player,this._clickEvent,this._onAdClickToResume),this._unlisten(this.player,"canplay",this._onAdCanPlay),this._unlisten(this.player,"timeupdate",this._onAdTick),this._unlisten(this.player,"ended",this._showNextAd),this._listen(this.player,"canplay",this._onVideoCanPlay),this._listen(this.player,"play",this._checkForPreroll),this._listen(this.player,"timeupdate",this._checkForMidroll),this._listen(this.player,"ended",this._checkForPostroll),typeof this.takeoverCallbacks.onRelease=="function"&&this.takeoverCallbacks.onRelease(this.player)},VideoplazaAds.prototype._onAdsReceived=function(t){this.log("got ads",t),this.ads=t,this.adIndex=-1,this._showNextAd()},VideoplazaAds.prototype._showNextAd=function(){this.adIndex++;if(!this.adsEnabled||this.adIndex>=this.ads.length)return this.log("no more ads"),typeof this.skipHandler.end=="function"&&this.skipHandler.end.call(this),this._resumeOriginalVideo(),!1;this.log("showing ad #"+this.adIndex),this.ad=this.ads[this.adIndex];switch(this.ad.type){case"standard_spot":return this.log("found standard spot"),this._displayAdCreatives(this.ad.creatives),!0;case"inventory":return this.log("found inventory"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this._showNextAd();default:return this._onVideoplazaError("ad format "+this.ad.type+" not supported"),!1}},VideoplazaAds.prototype._showCompanionBanner=function(t){this.log("show companion banner",t);if(typeof this.companionHandler!="function")return!1;var n='<iframe scrolling="no" frameborder="0" width="'+t.width+'" '+'height="'+t.height+'" '+'src="'+t.resource+'"></iframe>';return this.companionHandler(n,t.zoneId,t.width,t.height)?(this.tracker.track(t,this.trackingEvents.creative.creativeView),!0):!1},VideoplazaAds.prototype._displayAdCreatives=function(t){this.adVideo=null,this.log("found "+t.length+" creatives for ad");for(var n=0,r=t.length;n<r;n++)t[n].id==="video"?(this.log("found video creative",t[n]),this.adVideo=t[n]):t[n].type==="companion"&&(this.log("found companion creative",t[n]),this._showCompanionBanner(t[n])||this.logError("Videoplaza error: no way of displaying companion ad"));if(!this.adVideo){this.logError("Videoplaza error: bad ad - no video",this.ad),this._showNextAd();return}this._playVideoAd()},VideoplazaAds.prototype._onVideoplazaError=function(t){this.logError("Videoplaza error: "+t),this._resumeOriginalVideo()},VideoplazaAds.prototype._runAds=function(t,n){this.player.pause(),this.requestSettings.insertionPointType=t,n?this.requestSettings.playbackPosition=this.player.currentTime:this.requestSettings.playbackPosition=null;var r=this,i=function(t){r._onAdsReceived.call(r,t)},s=function(t){r._onVideoplazaError.call(r,t)};this.adCall.requestAds(this.contentMeta,this.requestSettings,i,s)},VideoplazaAds.prototype._onAdPlay=function(){this.adPlaying?(this.log("ad resumed"),this.tracker.track(this.adVideo,this.trackingEvents.creative.resume)):(this.log("ad started playing"),this.tracker.track(this.ad,this.trackingEvents.ad.impression),this.tracker.track(this.adVideo,this.trackingEvents.creative.creativeView),this.tracker.track(this.adVideo,this.trackingEvents.creative.start)),this.adPlaying=!0},VideoplazaAds.prototype._onAdClick=function(t){return this.log("ad click through to "+this.adVideo.clickThroughUri),this.tracker.track(this.adVideo,this.trackingEvents.creative.clickThrough),window.open(this.adVideo.clickThroughUri,"_blank"),this.player.controls=!0,this.player.pause(),this._unlisten(this.player,this._clickEvent,this._onAdClick),this._listen(this.player,this._clickEvent,this._onAdClickToResume),t.preventDefault(),!1},VideoplazaAds.prototype._onAdTick=function(){if(!(this.player&&this.adVideo&&this.adPlaying))return this.log("Player or ad video not ready"),!1;var t=this.player.currentTime/this.adVideo.duration;if(this.unsentQuartiles.length&&t>this.unsentQuartiles[0]){var n=this.unsentQuartiles.shift();switch(n){case.25:this.log("logged first quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.firstQuartile);break;case.5:this.log("logged midpoint"),this.tracker.track(this.adVideo,this.trackingEvents.creative.midpoint);break;case.75:this.log("logged third quartile"),this.tracker.track(this.adVideo,this.trackingEvents.creative.thirdQuartile)}}return!0},VideoplazaAds.prototype._prepareAdPlayback=function(){return this.log("told to create ad player"),this.adPlaying?!1:this.player?(this.log("actually created ad player"),this._playerState.originalSrc!==null&&this.log("Player state has src set",this._playerState.originalSrc,this.player.currentSrc),this._playerState.originalSrc=this.player.currentSrc,this._playerState.timeToResume=this.player.currentTime,this._playerState.ended=this.player.ended,this.log("saved state",this._playerState,this.player.currentTime),this._takeover(),this.adPlaying=!1,!0):!1},VideoplazaAds.prototype._playVideoAd=function(){this.log("playing ad",this.adVideo),this.unsentQuartiles=[.25,.5,.75],this._prepareAdPlayback(),typeof this.skipHandler.start=="function"&&this.skipHandler.start.call(this,this.adVideo.duration),this.player.setAttribute("src",this.adVideo.mediaFiles[0].uri),this.player.load()},VideoplazaAds.prototype._onAdCanPlay=function(){this.player.play(),this.player.currentTime=0},VideoplazaAds.prototype._onAdClickToResume=function(){this.log("-- click to resume"),this.player.play()},VideoplazaAds.prototype._onVideoCanPlay=function(){if(this._playerState.timeToResume===0||this._playerState.timeToResume===null){this.player.play();return}this._playerState.isBuffering||this.player.play();if(this.player.seekable.length===0||this.player.seekable.end(0)<this._playerState.timeToResume){this.player.pause(),this._playerState.isBuffering=!0,setTimeout(this._onVideoCanPlay,200);return}this.player.currentTime=this._playerState.timeToResume,this.player.play(),this._playerState.isBuffering=!1,this._playerState.timeToResume=0},VideoplazaAds.prototype._resumeOriginalVideo=function(){this.log("resuming watched player",this._playerState),this.player&&!this._playerState.ended&&(this.player.src===this._playerState.originalSrc?this.player.play():(this.player.src=this._playerState.originalSrc,this.player.load())),this.adPlaying=!1,this._release(),this._playerState.ended&&(this.player.src=this._playerState.originalSrc,this._triggerVideoEvent("ended"))},VideoplazaAds.prototype._triggerVideoEvent=function(t){if(!this.player)return;var n;n=document.createEvent("HTMLEvents"),n.initEvent(t,!0,!0),this.player.dispatchEvent(n)},VideoplazaAds.prototype._checkForPreroll=function(){this.hasShownPreroll||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0)},VideoplazaAds.prototype._checkForMidroll=function(){if(this.adPlaying)return!1;if(this.midrolls.length===0)return!1;var t=null;for(var n=0,r=this.midrolls.length;n<r;n++){if(this.midrolls[n]>this.player.currentTime)break;t=n}return t!==null&&t!==this.lastPlayedMidroll?(this.log("playing overdue midroll "+t),this.lastPlayedMidroll=t,this._runAds("playbackPosition",!0),!0):!1},VideoplazaAds.prototype._checkForPostroll=function(){this.hasShownPostroll||(this._runAds("onContentEnd"),this.hasShownPostroll=!0)},VideoplazaAds.prototype.watchPlayer=function(t){return this.log("told to watch player",t),t.tagName.toLowerCase()!=="video"?(this.logError("not watching player - not a video element"),!1):(this.player=t,this.hasShownPreroll=!1,this.hasShownPostroll=!1,this.player.paused||(this._runAds("onBeforeContent"),this.hasShownPreroll=!0),this._listen(this.player,"play",this._checkForPreroll),this._listen(this.player,"timeupdate",this._checkForMidroll),this._listen(this.player,"ended",this._checkForPostroll),!0)},typeof Function.prototype.bind=="undefined"&&(Function.prototype.bind=function(){var e=this,t=Array.prototype.slice.call(arguments),n=t.shift();return function(){var r=t.concat(Array.prototype.slice.call(arguments));return this!==window&&r.push(this),e.apply(n,r)}});